# ğŸ—ï¸ MEV Protection Scanner - Architecture

## System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT LAYER                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚   Wallet     â”‚  â”‚  Trading Bot â”‚  â”‚   DApp UI    â”‚              â”‚
â”‚  â”‚ Application  â”‚  â”‚              â”‚  â”‚              â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚                 â”‚                 â”‚                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚                 â”‚
          â”‚   HTTP POST     â”‚                 â”‚
          â”‚   + x402        â”‚                 â”‚
          â”‚   Payment       â”‚                 â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AGENT LAYER                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              HTTP Server (Hono)                               â”‚ â”‚
â”‚  â”‚  Endpoints:                                                   â”‚ â”‚
â”‚  â”‚  â€¢ POST /entrypoints/scan_transaction/invoke                 â”‚ â”‚
â”‚  â”‚  â€¢ POST /entrypoints/status/invoke                           â”‚ â”‚
â”‚  â”‚  â€¢ GET  /health                                              â”‚ â”‚
â”‚  â”‚  â€¢ GET  /.well-known/agent.json                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         @lucid-dreams/agent-kit Middleware                    â”‚ â”‚
â”‚  â”‚  â€¢ x402 payment validation                                   â”‚ â”‚
â”‚  â”‚  â€¢ Zod schema validation                                     â”‚ â”‚
â”‚  â”‚  â€¢ AgentCard manifest generation                            â”‚ â”‚
â”‚  â”‚  â€¢ Error handling                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                MEVScanner Core                                â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  analyzeMEVRisk()                                            â”‚ â”‚
â”‚  â”‚    â”‚                                                          â”‚ â”‚
â”‚  â”‚    â”œâ”€â”€â–º fetchMempoolTransactions()                           â”‚ â”‚
â”‚  â”‚    â”‚      â”œâ”€ Infura WebSocket                               â”‚ â”‚
â”‚  â”‚    â”‚      â”œâ”€ Blocknative API                                â”‚ â”‚
â”‚  â”‚    â”‚      â””â”€ Simulated (dev)                                â”‚ â”‚
â”‚  â”‚    â”‚                                                          â”‚ â”‚
â”‚  â”‚    â”œâ”€â”€â–º detectSandwichAttack()                              â”‚ â”‚
â”‚  â”‚    â”‚      â”œâ”€ Pattern recognition                            â”‚ â”‚
â”‚  â”‚    â”‚      â”œâ”€ Gas analysis                                   â”‚ â”‚
â”‚  â”‚    â”‚      â””â”€ Value clustering                               â”‚ â”‚
â”‚  â”‚    â”‚                                                          â”‚ â”‚
â”‚  â”‚    â”œâ”€â”€â–º detectFrontRunning()                                â”‚ â”‚
â”‚  â”‚    â”‚      â”œâ”€ Gas price statistics                           â”‚ â”‚
â”‚  â”‚    â”‚      â”œâ”€ Mempool density                                â”‚ â”‚
â”‚  â”‚    â”‚      â””â”€ Outlier detection                              â”‚ â”‚
â”‚  â”‚    â”‚                                                          â”‚ â”‚
â”‚  â”‚    â”œâ”€â”€â–º calculateGasPercentile()                            â”‚ â”‚
â”‚  â”‚    â”‚                                                          â”‚ â”‚
â”‚  â”‚    â”œâ”€â”€â–º estimatePotentialLoss()                             â”‚ â”‚
â”‚  â”‚    â”‚                                                          â”‚ â”‚
â”‚  â”‚    â””â”€â”€â–º generateProtectionSuggestions()                     â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATA SOURCES LAYER                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Infura WebSocket â”‚  â”‚  Blocknative API â”‚  â”‚   Simulated     â”‚  â”‚
â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚   Mempool       â”‚  â”‚
â”‚  â”‚ â€¢ Real-time      â”‚  â”‚ â€¢ REST API       â”‚  â”‚   (Dev Mode)    â”‚  â”‚
â”‚  â”‚   mempool        â”‚  â”‚ â€¢ Enhanced       â”‚  â”‚                 â”‚  â”‚
â”‚  â”‚ â€¢ Ethereum       â”‚  â”‚   metadata       â”‚  â”‚ â€¢ 20-50 txs     â”‚  â”‚
â”‚  â”‚   mainnet        â”‚  â”‚ â€¢ Multiple       â”‚  â”‚ â€¢ Realistic     â”‚  â”‚
â”‚  â”‚                  â”‚  â”‚   chains         â”‚  â”‚   patterns      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow Diagram

```
User Request
    â”‚
    â”œâ”€â–º 1. POST /entrypoints/scan_transaction/invoke
    â”‚      { token_in, token_out, amount_in, dex }
    â”‚
    â”œâ”€â–º 2. Payment Check (x402 middleware)
    â”‚      â”œâ”€ No payment? â†’ 402 Payment Required
    â”‚      â””â”€ Valid payment? â†’ Continue
    â”‚
    â”œâ”€â–º 3. Input Validation (Zod)
    â”‚      â”œâ”€ Invalid? â†’ 400 Bad Request
    â”‚      â””â”€ Valid? â†’ Continue
    â”‚
    â”œâ”€â–º 4. Fetch Mempool Data
    â”‚      â”œâ”€ Connect to Infura WebSocket
    â”‚      â”œâ”€ Filter by DEX router address
    â”‚      â””â”€ Collect 20-100 pending transactions
    â”‚
    â”œâ”€â–º 5. Sandwich Attack Detection
    â”‚      â”œâ”€ Group by sender address
    â”‚      â”œâ”€ Check sequential nonces
    â”‚      â”œâ”€ Analyze gas prices
    â”‚      â”œâ”€ Find value clusters
    â”‚      â””â”€ Calculate risk score (0-30 points)
    â”‚
    â”œâ”€â–º 6. Front-Running Detection
    â”‚      â”œâ”€ Calculate gas statistics
    â”‚      â”œâ”€ Identify high-gas outliers
    â”‚      â”œâ”€ Measure mempool density
    â”‚      â””â”€ Calculate risk score (0-40 points)
    â”‚
    â”œâ”€â–º 7. Risk Aggregation
    â”‚      â”œâ”€ Combine scores (weighted)
    â”‚      â”œâ”€ Determine attack type
    â”‚      â””â”€ Total risk: 0-100
    â”‚
    â”œâ”€â–º 8. Loss Estimation
    â”‚      â”œâ”€ Apply risk percentage to amount
    â”‚      â”œâ”€ Convert to USD
    â”‚      â””â”€ Round to 2 decimals
    â”‚
    â”œâ”€â–º 9. Generate Suggestions
    â”‚      â”œâ”€ Risk > 60? â†’ Flashbots, private RPC
    â”‚      â”œâ”€ Risk > 40? â†’ Increase slippage
    â”‚      â”œâ”€ High competition? â†’ Wait or split trade
    â”‚      â””â”€ Compile actionable list
    â”‚
    â””â”€â–º 10. Return Response
           {
             risk_score: 75,
             attack_type: "sandwich",
             estimated_loss_usd: 45.50,
             protection_suggestions: [...],
             competing_txs: 42,
             gas_price_percentile: 45,
             detected_patterns: [...],
             recommended_gas_price: "38 gwei",
             optimal_slippage: 2.5
           }
```

## Component Interactions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COMPONENT DIAGRAM                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ createAgentApp()                                             â”‚
â”‚  â”œâ”€ Configure metadata (name, version, description)         â”‚
â”‚  â”œâ”€ Setup payment config (paymentsFromEnv)                  â”‚
â”‚  â”œâ”€ Initialize Hono app                                     â”‚
â”‚  â””â”€ Return { app, addEntrypoint, config, payments }         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ uses
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ addEntrypoint()                                              â”‚
â”‚  â”œâ”€ Define key, description, schemas                        â”‚
â”‚  â”œâ”€ Register POST /entrypoints/:key/invoke                  â”‚
â”‚  â”œâ”€ Setup payment middleware (if priced)                    â”‚
â”‚  â””â”€ Connect to handler function                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ calls
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ handler({ input })                                           â”‚
â”‚  â”œâ”€ Receive validated input                                 â”‚
â”‚  â”œâ”€ Call MEVScanner.analyzeMEVRisk()                        â”‚
â”‚  â”œâ”€ Format response                                         â”‚
â”‚  â””â”€ Return { output, usage }                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ invokes
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MEVScanner Class                                             â”‚
â”‚                                                              â”‚
â”‚ Properties:                                                  â”‚
â”‚  â€¢ infuraWsUrl: string                                      â”‚
â”‚  â€¢ blocknativeApiKey: string                                â”‚
â”‚                                                              â”‚
â”‚ Methods:                                                     â”‚
â”‚  â€¢ analyzeMEVRisk() â”€â”€â”€â”€â”€â”€â”€â”€â–º Main orchestration           â”‚
â”‚  â€¢ fetchMempoolTransactions() â”€â–º Data collection           â”‚
â”‚  â€¢ detectSandwichAttack() â”€â”€â”€â”€â–º Pattern detection          â”‚
â”‚  â€¢ detectFrontRunning() â”€â”€â”€â”€â”€â”€â”€â–º Statistical analysis      â”‚
â”‚  â€¢ calculateGasPercentile() â”€â”€â–º Ranking                    â”‚
â”‚  â€¢ estimatePotentialLoss() â”€â”€â”€â”€â–º Financial impact          â”‚
â”‚  â€¢ generateProtectionSuggestions() â”€â–º Recommendations      â”‚
â”‚  â€¢ recommendGasPrice() â”€â”€â”€â”€â”€â”€â”€â”€â–º Optimization              â”‚
â”‚  â€¢ calculateOptimalSlippage() â”€â–º Risk mitigation           â”‚
â”‚                                                              â”‚
â”‚ Helper Methods:                                              â”‚
â”‚  â€¢ findClusters()                                           â”‚
â”‚  â€¢ calculateStdDev()                                        â”‚
â”‚  â€¢ generateSimulatedMempool()                               â”‚
â”‚  â€¢ generateSwapInput()                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Payment Flow (x402)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚                                      â”‚  Agent   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                                                â”‚
     â”‚  1. POST /entrypoints/scan_transaction/invoke â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚     (no payment header)                       â”‚
     â”‚                                                â”‚
     â”‚  2. 402 Payment Required                      â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚  {                                             â”‚
     â”‚    x402Version: 1,                            â”‚
     â”‚    accepts: [{                                â”‚
     â”‚      scheme: "exact",                         â”‚
     â”‚      network: "base",                         â”‚
     â”‚      maxAmountRequired: "1000",               â”‚
     â”‚      payTo: "0xAddress",                      â”‚
     â”‚      asset: "base-unit"                       â”‚
     â”‚    }]                                          â”‚
     â”‚  }                                             â”‚
     â”‚                                                â”‚
     â”‚  3. Create & Submit Payment on Base           â”‚
     â”‚     (via wallet/SDK)                          â”‚
     â”‚                                                â”‚
     â”‚  4. POST /entrypoints/scan_transaction/invoke â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚    X-Payment-Transaction: 0xTxHash            â”‚
     â”‚                                                â”‚
     â”‚                          5. Validate Payment  â”‚
     â”‚                             (x402 middleware) â”‚
     â”‚                                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                      â”‚ Valid? â”‚
     â”‚                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                           Yesâ”‚
     â”‚                                              â–¼
     â”‚                          6. Process Request  â”‚
     â”‚                             (scan mempool)   â”‚
     â”‚                                                â”‚
     â”‚  7. 200 OK                                    â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚  {                                             â”‚
     â”‚    run_id: "...",                             â”‚
     â”‚    status: "completed",                       â”‚
     â”‚    output: { risk_score, ... },               â”‚
     â”‚    usage: { total_tokens: 1 }                 â”‚
     â”‚  }                                             â”‚
     â”‚                                                â”‚
```

## Detection Algorithm Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         SANDWICH ATTACK DETECTION ALGORITHM              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Input: mempoolTxs[], tokenIn, tokenOut, amountIn
Output: { riskScore: 0-100, patterns: [] }

Step 1: Group by Address
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ txsByAddress = Map<address, tx[]>â”‚
  â”‚ Group all transactions by sender â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
Step 2: Find Sequential Patterns
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ For each address with 2+ txs:    â”‚
  â”‚   â€¢ Check if nonces are sequentialâ”‚
  â”‚   â€¢ If yes: +30 risk points      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
Step 3: Analyze Gas Prices
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Calculate average gas price       â”‚
  â”‚ For suspicious addresses:         â”‚
  â”‚   â€¢ If gas > avg * 1.5: +25 pts  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
Step 4: Value Clustering
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Find transactions with similar    â”‚
  â”‚ values (within 10% of each other) â”‚
  â”‚ If 2+ clusters found: +20 pts     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
Step 5: Return Result
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    risk = min(100, total points)
    return { riskScore: risk, patterns }


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          FRONT-RUNNING DETECTION ALGORITHM               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Input: mempoolTxs[], tokenIn, tokenOut
Output: { riskScore: 0-100, patterns: [] }

Step 1: Gas Statistics
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Calculate:                        â”‚
  â”‚   â€¢ avgGasPrice                  â”‚
  â”‚   â€¢ maxGasPrice                  â”‚
  â”‚   â€¢ stdDev                       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
Step 2: Mempool Density
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ If mempoolTxs.length > 30:       â”‚
  â”‚   +15 risk points                â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
Step 3: High Gas Transactions
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Count txs with gas > avg * 1.3   â”‚
  â”‚ If count > 5: +25 pts            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
Step 4: Extreme Outliers
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Count txs with gas > avg * 2     â”‚
  â”‚ If any found: +35 pts            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
Step 5: Volatility Check
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ If stdDev > avg * 0.5:           â”‚
  â”‚   +15 pts (high volatility)      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
Step 6: Return Result
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    risk = min(100, total points)
    return { riskScore: risk, patterns }
```

## Deployment Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PRODUCTION DEPLOYMENT                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Option 1: Cloudflare Workers (Edge Computing)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Cloudflare Global Network            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Region:  â”‚  â”‚ Region:  â”‚  â”‚ Region:  â”‚           â”‚
â”‚  â”‚ US-West  â”‚  â”‚ Europe   â”‚  â”‚ Asia     â”‚  ...      â”‚
â”‚  â”‚  Worker  â”‚  â”‚  Worker  â”‚  â”‚  Worker  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜           â”‚
â”‚       â”‚             â”‚             â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚             â”‚             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
            Closest to User
                      â”‚
                      â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Infura API   â”‚
              â”‚  (Mempool)    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Option 2: Traditional Server (Railway/Fly.io/VPS)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Load Balancer                        â”‚
â”‚                  (Optional)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Instance 1   â”‚  â”‚  Instance 2   â”‚  ...
    â”‚  MEV Scanner  â”‚  â”‚  MEV Scanner  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         Shared State               â”‚
    â”‚         (Optional Redis)           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## File Organization

```
Project Root
â”‚
â”œâ”€â”€ Core Implementation
â”‚   â””â”€â”€ mev-protection-scanner.ts (740 lines)
â”‚       â”œâ”€â”€ Imports & Types (50 lines)
â”‚       â”œâ”€â”€ Configuration (80 lines)
â”‚       â”œâ”€â”€ MEVScanner Class (500 lines)
â”‚       â””â”€â”€ Entrypoint Definitions (110 lines)
â”‚
â”œâ”€â”€ Integration Examples
â”‚   â””â”€â”€ example-client.ts (450 lines)
â”‚       â”œâ”€â”€ Basic Usage
â”‚       â”œâ”€â”€ Agent-kit Integration
â”‚       â”œâ”€â”€ Trading Bot Example
â”‚       â”œâ”€â”€ Wallet Integration
â”‚       â””â”€â”€ Batch Operations
â”‚
â”œâ”€â”€ Testing
â”‚   â””â”€â”€ mev-scanner.test.ts (180 lines)
â”‚       â”œâ”€â”€ API Tests
â”‚       â”œâ”€â”€ Payment Tests
â”‚       â””â”€â”€ Performance Tests
â”‚
â”œâ”€â”€ Configuration
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â”œâ”€â”€ .env.example
â”‚   â””â”€â”€ .gitignore
â”‚
â””â”€â”€ Documentation
    â”œâ”€â”€ README.md (Full guide)
    â”œâ”€â”€ DEPLOYMENT.md (Platform guides)
    â”œâ”€â”€ QUICKSTART.md (5-min setup)
    â”œâ”€â”€ PROJECT_OVERVIEW.md (This file)
    â””â”€â”€ ARCHITECTURE.md (Technical details)
```

## Technology Decisions

**Why Bun?**
- âœ… 3x faster than Node.js
- âœ… Native TypeScript support
- âœ… Built-in test runner
- âœ… Optimized for serverless

**Why Hono?**
- âœ… 5-10x faster than Express
- âœ… Works everywhere (Cloudflare, Bun, Node)
- âœ… Minimal overhead
- âœ… TypeScript-first

**Why Zod?**
- âœ… Runtime type validation
- âœ… TypeScript inference
- âœ… JSON Schema generation
- âœ… Excellent error messages

**Why Base Network?**
- âœ… Low transaction fees (<$0.01)
- âœ… Fast confirmation (2 seconds)
- âœ… L2 scalability
- âœ… Ethereum ecosystem compatibility

**Why x402?**
- âœ… Pay-per-use model
- âœ… No subscriptions needed
- âœ… Automatic payment validation
- âœ… Growing ecosystem

## Performance Optimization Strategies

**1. Mempool Caching**
```typescript
// Cache mempool for 30 seconds
const cacheKey = `mempool:${dex}:${timestamp / 30000 | 0}`;
```

**2. Parallel Processing**
```typescript
// Run detection algorithms in parallel
const [sandwich, frontRun] = await Promise.all([
  detectSandwichAttack(),
  detectFrontRunning(),
]);
```

**3. Early Returns**
```typescript
// Return early if no competing transactions
if (mempoolTxs.length === 0) {
  return lowRiskResponse();
}
```

**4. Efficient Data Structures**
```typescript
// Use Maps for O(1) lookups
const txsByAddress = new Map<string, Transaction[]>();
```

**5. Lazy Evaluation**
```typescript
// Only fetch full transaction data if needed
if (riskScore > threshold) {
  const fullTxData = await fetchDetails(txHash);
}
```

## Monitoring & Observability

**Key Metrics to Track:**
- Request rate (requests/second)
- Response time (p50, p95, p99)
- Error rate (%)
- Payment success rate (%)
- Detection accuracy (validated samples)
- Mempool API latency
- Cache hit rate

**Logging Strategy:**
```typescript
{
  level: "info",
  timestamp: "2024-01-01T12:00:00Z",
  request_id: "uuid",
  endpoint: "/entrypoints/scan_transaction/invoke",
  duration_ms: 1847,
  risk_score: 75,
  attack_type: "sandwich",
  mempool_size: 42,
  payment_verified: true
}
```

---

**Architecture Version:** 1.0.0  
**Last Updated:** 2024  
**Author:** MEV Protection Team
